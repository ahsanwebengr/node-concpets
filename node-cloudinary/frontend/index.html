<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Cloudinary Upload Demo</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 720px;
        margin: 40px auto;
        padding: 0 16px;
      }
      .preview {
        max-width: 100%;
        margin-top: 12px;
      }
      .result {
        margin-top: 12px;
        white-space: pre-wrap;
        background: #f7f7f7;
        padding: 12px;
        border-radius: 6px;
      }
    </style>
  </head>
  <body>
    <h1>Cloudinary Upload Demo</h1>

    <p>Select a file and upload it to the server demo at <code>/upload</code>.</p>

    <input id="file" type="file" accept="image/*" />
    <button id="upload">Upload</button>

    <div id="status" class="result" aria-live="polite"></div>

    <script>
      const fileInput = document.getElementById('file');
      const uploadBtn = document.getElementById('upload');
      const status = document.getElementById('status');

      function show(msg) {
        status.textContent = msg;
      }

      uploadBtn.addEventListener('click', async () => {
        const f = fileInput.files && fileInput.files[0];
        if (!f) return show('Pick a file first');

        const form = new FormData();
        form.append('file', f);

        show('Uploading...');
        try {
          // API root: if you serve the frontend from the same server this can be '/'.
          // For local testing when the server runs on port 3004, set API_ROOT to
          // 'http://localhost:3004' or leave as default below.
          const API_ROOT = window.API_ROOT || 'http://localhost:3004';
          const res = await fetch(API_ROOT + '/upload', { method: 'POST', body: form });
          // Be defensive when parsing the response: some error paths may return
          // empty or non-JSON bodies which cause `res.json()` to throw.
          let data = null;
          const ct = res.headers.get('content-type') || '';
          if (ct.includes('application/json')) {
            try {
              data = await res.json();
            } catch (e) {
              data = null;
            }
          } else {
            try {
              data = await res.text();
            } catch (e) {
              data = null;
            }
          }

          if (!res.ok) {
            const msg =
              data && data.error
                ? data.error
                : typeof data === 'string'
                ? data
                : res.statusText;
            show('Upload failed: ' + msg);
            return;
          }

          show('Upload success!\n' + JSON.stringify(data, null, 2));
        } catch (err) {
          show('Error: ' + err.message);
        }
      });
    </script>
  </body>
</html>
